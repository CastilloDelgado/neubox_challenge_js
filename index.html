<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neubox Challenge</title>
  </head>

  <body>
    <div class="container p-3 text-center">
      <div class="row justify-content-center">
        <div
          class="col-5 px-3 py-5 m-3 rounded"
          style="background-color: rgb(255, 187, 187)"
        >
          <p class="h3">Problema 1</p>
          <label for="input1">Ingresa un archivo .txt</label><br />
          <input type="file" accept=".txt" id="input1" name="input1" />
        </div>
        <div
          class="col-5 px-3 py-5 m-3 rounded"
          style="background-color: rgb(163, 206, 255)"
        >
          <p class="h3">Problema 2</p>
          <label for="input2">Ingresa un archivo .txt</label><br />
          <input type="file" accept=".txt" id="input2" name="input2" />
        </div>
      </div>
    </div>
  </body>

  <script type="text/javascript">
    /*
    ----------------------------------------------------------------
     Solución al Problema 1 - Se ejecuta cuando agregas el archivo
    ----------------------------------------------------------------
    */

    document.getElementById("input1").addEventListener("change", function () {
      var fr = new FileReader();
      fr.onload = function () {
        // Dividir texto por lineas y eliminamos caracteres especiales
        let lines = fr.result
          .split("\n")
          .map((line, index) =>
            index !== 0 ? line.replace(/[^a-zA-Z0-9]/g, "") : line
          );

        // Extraemos los valores de la primera línea y los convertimos a enteros
        let values = lines[0].split(" ").map((line) => parseInt(line));

        /*
        Validamos que la información del archivo sea correcta y corresponsa a las siguientes instrucciones

        La primera línea son tres enteros M1, M2 y N. M1 y M2 es el número de
        caracteres de las dos instrucciones y N es el número de caracteres en el
        mensaje.
            - N siempre estará entre 3 y 5000 inclusive
            - M1 y M2 siempre estarán entre 2 y 50 inclusive
            - La segunda línea contiene la primera instrucción
            - La tercera línea contiene la segunda instrucción
            - La cuarta línea contiene el mensaje
            - Los caracteres posibles en el mensaje son [a-zA-Z0-9]

        Si el archivo no cumple con estas caracteristicas el programa se detiene
        */
        if (
          !(values[2] >= 3 && values[2] <= 5000) ||
          !(values[0] >= 2 && values[0] <= 50) ||
          !(values[1] >= 2 && values[1] <= 50) ||
          lines[1].length !== values[0] ||
          lines[2].length !== values[1] ||
          lines[3].length !== values[2]
        ) {
          let result = "";
          !(values[2] >= 3 && values[2] <= 5000)
            ? (result +=
                "El valor en N (" +
                parseInt(values[2]) +
                ") no está entre 3 y 5000\n")
            : null;
          !(values[0] >= 2 && values[0] <= 50)
            ? (result +=
                "El valor en M1 (" + values[0] + ") no está entre 2 y 50\n")
            : null,
            !(values[1] >= 2 && values[1] <= 50)
              ? (result +=
                  "El valor en M2 (" + values[1] + ") no está entre 2 y 50\n")
              : null;

          lines[1].length !== values[0]
            ? (result +=
                "El valor M1 no coincide con la cantidad de caracteres en la primera instrucción\n")
            : null;
          lines[2].length !== values[1]
            ? (result +=
                "El valor M2 no coincide con la cantidad de caracteres en la segunda instrucción\n")
            : null;
          lines[3].length !== values[2]
            ? (result +=
                "El valor N no coincide con la cantidad de caracteres en el mensaje\n")
            : null;
          alert(result);
          location.reload();
          return;
        }

        /* Validar si las instrucciones tienes caracteres dobles */
        let errors = "";
        for (let i = 1; i <= 2; i++) {
          let lastChar = null;
          lines[i].split("").forEach((char, index) => {
            if (!lastChar || lastChar !== char) {
              lastChar = char;
            } else {
              if (lastChar === char) {
                errors +=
                  "Mensaje " +
                  i +
                  " con caracter ' " +
                  lastChar +
                  " ' duplicado en la posición " +
                  index +
                  "\n";
              }
            }
          });
        }

        if (errors !== "") {
          alert(errors);
          location.reload();
          return;
        }

        // Limpiar los caracteres duplicados en la cadena
        let stringClean = lines[3].split("").reduce((acc, cur, index) => {
          if (acc.length >= 1 && acc[acc.length - 1] !== cur) return acc + cur;
          return acc;
        });

        // Eliminamos los caracteres especiales
        lines[1] = lines[1].replace(/[^a-zA-Z0-9 ]/g, "");
        lines[2] = lines[2].replace(/[^a-zA-Z0-9 ]/g, "");

        // Validamos si hay más de 1 mensaje en la cadena
        if (
          stringClean.indexOf(lines[1]) !== -1 &&
          stringClean.indexOf(lines[2]) !== -1
        ) {
          alert("Hay mas de 1 mensaje en la cadena de caracteres");
          location.reload();
          return;
        }

        // Guardamos los resultados en una cadena
        let result =
          (stringClean.indexOf(lines[1]) === -1 ? "No" : "Si") +
          "\n" +
          (stringClean.indexOf(lines[2]) === -1 ? "No" : "Si");

        // Creamos el archivo de salida
        var element = document.createElement("a");
        element.setAttribute(
          "href",
          "data:text/plant;charset=utf-8," + encodeURIComponent(result)
        );
        element.setAttribute("download", "output.txt");
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);

        location.reload();
      };

      fr.readAsText(this.files[0]);
    });

    /*
    ----------------------------------------------------------------
     Solución al Problema 2 - Se ejecuta cuando agregas el archivo
    ----------------------------------------------------------------
    */
    document.getElementById("input2").addEventListener("change", function () {
      var fr = new FileReader();
      fr.onload = function () {
        // Dividir texto en lineas
        let lines = fr.result.split("\n").map((line, index) => {
          if (index === 0) {
            return parseInt(line);
          } else {
            return line.split(" ").map((value) => parseInt(value));
          }
        });

        // Validar información
        let result = "";

        if (
          isNaN(lines[0]) ||
          (!lines[0] >= 1 && lines[0] <= 1000) ||
          lines[0] !== lines.length - 1
        ) {
          isNaN(lines[0])
            ? (result += "El valor en línea 1 no es un número\n")
            : null;
          !lines[0] >= 1 && lines[0] <= 1000
            ? (result +=
                "El valor de la primera línea (" +
                lines[0] +
                ") no está entre 1 y 1000\n")
            : null;
          lines[0] !== lines.length - 1
            ? (result +=
                "El valor de la primera línea (" +
                lines[0] +
                ") no es igual al numero de rondas capturadas en el archivo (" +
                (lines.length - 1) +
                ")\n")
            : null;
        }

        lines.forEach((line, index) => {
          if (index !== 0) {
            line.forEach((value, player) => {
              isNaN(value)
                ? (result +=
                    "En la ronda " +
                    index +
                    ", el jugador " +
                    (player + 1) +
                    " no tienen un valor valido\n")
                : null;
            });
          }
        });

        if (result !== "") {
          alert(result);
          location.reload();
          return;
        }

        let winner = "";
        let accScoreP1 = 0,
          accScoreP2 = 0,
          bestScore = 0;

        lines.forEach((line, index) => {
          if (index !== 0) {
            let values = line;
            accScoreP1 += values[0]
            accScoreP2 += values[1]

            let score =
            accScoreP1 - accScoreP2 < 0
                ? (accScoreP1 - accScoreP2) * -1
                : accScoreP1 - accScoreP2;

            if (score > bestScore) {
              bestScore = score;
              winner = accScoreP1 - accScoreP2 < 0 ? "2" : "1";
            }
          }
        });

        // Guardamos el resultado en una variable
        let finalResult = winner + " " + bestScore;

        // Creamos el archivo de salida
        var element = document.createElement("a");
        element.setAttribute(
          "href",
          "data:text/plant;charset=utf-8," + encodeURIComponent(finalResult)
        );
        element.setAttribute("download", "output.txt");
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);

        location.reload();
      };

      fr.readAsText(this.files[0]);
    });

    function fileValidation() {}
  </script>
</html>
